<?php
session_start();
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>хНЧф║м-ComicJehad</title>
<link href="../style/common.css" rel="stylesheet" type="text/css" />
</head>

<?php
	//include_once "DB.php"; 
	require_once('check_safe.php');
	//trim()х&#65533;╜ц&#65533;бух&#65533;пф╗ец&#65533;кх&#65533;╗хбббимббим┤хбу╛чЪДчй║ч&#65533;╜хн&#65533;чмж
	
	if (isset($_SESSION['username'])) 
	{ 
        //echo "hello,";
        //echo "<a href=logout.php>бббзмжвувух&#65533;║ч&#65533;╗бббзмжЩЖ</a><br/>"; 
	} 
	else 
	{ 
		echo "хп╣ф╕&#65533;бббзмбббзм╡ббббьббь,ц&#65533;ббббьмбббзмбббзм┐&#65533;ц▓бцЬЙ<a href=enroll.php>ч&#65533;╗бббзмжЩЖ</a>!";
		exit;
	} 
	$username = $_SESSION['username'];
	$password = $_POST['password'];
	$cpassword =$_POST['cpassword'];
	$theEmail = trim($_POST['theEmail']);
	//$groupname = trim($_POST['groupname']);
	$thename = trim($_POST['thename']);
	$thephone = trim($_POST['thephone']);
	$theQQ = trim($_POST['theQQ']);
	$theID = trim($_POST['theID']);
	$themonth = trim($_POST['select1']);
	$theday = trim($_POST['select2']);
	$thehobby = trim($_POST['select3']);
	$thepic="";//хбббимббим┤хГПбббзмбббзмббббьббьпх╛&#65533;
	//ц&#65533;буц&#65533;оц&#65533;пх&#65533;жф╕║чй║цгвубббзмжк&#65533;
	/*
	if(empty($username)||empty($password)||empty($cpassword)||empty($theEmail)){
		echo "data invalid!";
		exit;
		}
		
	//хп&#65533;ча&#65533;бббзмж&#65533;┐х║жх&#65533;бббимббимц&#65533;н
	if(strlen($password)<6||strlen($password)>20){
		echo "password invalid";
		exit;
		}
		*/
	//бббзмбббзм┐&#65533;ц&#65533;ех&#65533;буц&#65533;буц&#65533;ох║&#65533;
	//бббзмбббзм┐&#65533;ц&#65533;ех&#65533;буц&#65533;буц&#65533;ох║&#65533;
	require('config.php');
	$db=new mysqli($host,$user,$dbpassword,$database);
	$db->query("set names 'utf8'");
	if (mysqli_connect_errno()) 	
	{
		echo 'Error: Could not connect to database. Please try again later.';
		exit;
	}
	//ц&#65533;ебббзмбббзмпвц&#65533;буц&#65533;ох║&#65533;я╝&#65533;чЬЛхблхЖЩчЪДч&#65533;ббббьмц&#65533;ббббьббьхРНц&#65533;пх&#65533;жхббббьббь▓ч╗&#65533;хн&#65533;х&#65533;ббббьм
	//$sql = "select * from user where username = "; 
	//$result = $db->query($sql);
	//if (DB::isError($result) ){ 
	//	echo "ц&#65533;буц&#65533;ох║&#65533;бббзмжФЩбббзмбббзмппя╝&#65533;".DB::errorMessage($result); 
	//	exit(); 
	//} 
	
	
	else{
		//rogers edit on 9.8 
		$sql = "select * from user where username='$username'";
		$result = $db->query($sql);
		$row = $result->fetch_row();
		$groupname = $row[3];
		$thepic=$row[5];
		$f=$_FILES['pic'];
		//echo GetFiletype($f['name']);
		//бббзмжЬАбббзмбббзмж&#65533;ц&#65533;┤ц&#65533;буф╕бббимббимх╝абббзмбббзмбббббьмя╝Мthegroup, benzi(groupurl)
		if(GetFiletype($f['name'])!='.'){//ф╕&#65533;ф╝аф║&#65533;хбббимббим┤хГП
			//echo "<script>alert('ф╕&#65533;ф╝аф║&#65533;хбббимббим┤хГП');</script>"; 
      		$dest_dir='../headphoto';//бббзмбббзмо╛хо&#65533;ф╕&#65533;ф╝ач&#65533;ох╜&#65533; 
      		$timestamp=date("y m d h m s");
      		$filetype=GetFiletype($f['name']);

// add by demonbug
if (($filetype == ".php") || ($filetype == ".jsp") || ($filetype == ".asp") || ($filetype == ".aspx"))
{
echo "invalid file type";
exit;
}

      		//$filename=iconv("utf-8","gbk",$f['name']); 
      		$thepic=$dest_dir.'/'.$timestamp.$filetype;//бббзмбббзмо╛ч╜оцЦЗф╗╢хРНф╕║ц&#65533;ецЬЯх&#65533;аф╕&#65533;цЦЗф╗╢хРНбббзмж&#65533;┐хЕНбббзмжЗНхбббимббим&#65533; 
      		$r=move_uploaded_file($f['tmp_name'],$thepic); 
      		chmod($thepic, 0755);//бббзмбббзмо╛хо&#65533;ф╕&#65533;ф╝ачЪДцЦЗф╗╢чЪДхб└&#65533;цвубббимм

			$sql1 = "UPDATE user SET pwd = '".$password."', thename='".$thename."', thepic='".$thepic."', thephone='".$thephone."', theQQ='".$theQQ."',theEmail='".$theEmail."',theID='".$theID."', themonth='".$themonth."',theday='".$theday."',thehobby='".$thehobby."' WHERE username='$username'";
			$result1=$db->query($sql1);
			$sql2="UPDATE benzi SET groupurl='".$thepic."' where groupname='".$groupname."'";
			//$sql2="UPDATE benzi SET groupurl='".$thepic."'";
			$result2=$db->query($sql2);
			if(($result1==null)||($result2==null)){
				echo "<script>alert('ц&#65533;буц&#65533;ох║&#65533;ч╗┤ц&#65533;бббимббимф╕н...бббзмбббзмпббббьббьчббббьм&#65533;хРОбббзмжЗНбббзмбббзмп&#65533;');</script>";
			}
			else{
				echo "<script>alert('ф┐оц&#65533;╣цИРхКЯя╝&#65533;');</script>";
			}
		}
		else{//ц▓бцЬЙф╕&#65533;ф╝ахбббимббим┤хГП
			//echo "<script>alert('ц▓бцЬЙф╕&#65533;ф╝ахбббимббим┤хГП');</script>";
			$sql1 = "UPDATE user SET pwd = '".$password."', thename='".$thename."', thephone='".$thephone."', theQQ='".$theQQ
			."',theEmail='".$theEmail."',theID='".$theID."', themonth='".$themonth."',theday='".$theday."',thehobby='".$thehobby."' WHERE username='$username'";
			$result1=$db->query($sql1);
			if($result1==null){
				echo "<script>alert('ц&#65533;буц&#65533;ох║&#65533;ч╗┤ц&#65533;бббимббимф╕н...бббзмбббзмпббббьббьчббббьм&#65533;хРОбббзмжЗНбббзмбббзмп&#65533;');</script>";
			}
			else{
				echo "<script>alert('ф┐оц&#65533;╣цИРхКЯя╝&#65533;');</script>";
			}
			
		}
      	
		//rogers edit on 9.8

		//хбу&#65533;чбббимббим╛х&#65533;вф┐бц&#65533;пцПТх&#65533;ец&#65533;буц&#65533;ох║&#65533;чЪДgroupбббзмбббзмбббббьм
		
		// $sql1 = "UPDATE thegroup SET groupname = '".$groupname."' WHERE username='$username'";
		
		// $result1 = $db->query($sql1);

		// if($result1&&$result1->num_rows&&$groupname!=""){
		// //ц&#65533;ебббзмбббзмпвц&#65533;буц&#65533;ох║&#65533;я╝&#65533;чЬЛхблхЖЩчЪДчбббимббим╛х&#65533;вхРНц&#65533;пх&#65533;жхббббьббь▓ч╗&#65533;хн&#65533;х&#65533;ббббьм
		// 	echo "<script language='javascript'>
  //     	  		alert('чбббимббим╛х&#65533;вхРНхббббьббь▓хн&#65533;х&#65533;ббббьм!');
		// 		history.back(-1);
  //       		</script>";
  //   	}
		// else{//чбббимббим╛х&#65533;вхРНф╕&#65533;хн&#65533;х&#65533;ббббьмя╝&#65533;х&#65533;пф╗ец&#65533;┤ц&#65533;╣
		// 	echo "<script>alert('got!');</script>";
		// 	if($_FILES['thepic']!=null){
		// 		echo "<script>alert('got!');</script>";
		// 		$f=$_FILES['thepic']; 
  //     			$dest_dir='../headphoto';//бббзмбббзмо╛хо&#65533;ф╕&#65533;ф╝ач&#65533;ох╜&#65533; 
  //     			$timestamp=date("y m d h m s");
  //     			$filetype=GetFiletype($f['name']);
  //     			//$filename=iconv("utf-8","gbk",$f['name']); 
  //     			$thepic=$dest_dir.'/'.$timestamp.$filetype;//бббзмбббзмо╛ч╜оцЦЗф╗╢хРНф╕║ц&#65533;ецЬЯх&#65533;аф╕&#65533;цЦЗф╗╢хРНбббзмж&#65533;┐хЕНбббзмжЗНхбббимббим&#65533; 
  //     			$r=move_uploaded_file($f['tmp_name'],$thepic); 
  //     			chmod($thepic, 0755);//бббзмбббзмо╛хо&#65533;ф╕&#65533;ф╝ачЪДцЦЗф╗╢чЪДхб└&#65533;цвубббимм
		// 	}
		// 	//хбу&#65533;ч&#65533;ббббьмц&#65533;ббббьббьф┐бц&#65533;пцПТх&#65533;ец&#65533;буц&#65533;ох║&#65533;чЪДuserбббзмбббзмбббббьм
		// 	//$sql2 = "UPDATE user SET pwd = '".$password."', groupname = '".$groupname."', thename='".$thename."', thepic='".$thepic."', thephone='".$thephone."', theQQ='".$theQQ."',theEmail='".$theEmail."',theID='".$theID."', themonth='".$themonth."',theday='".$theday."',thehobby='".$thehobby."' WHERE username='$username'";
		// 	$sql2 = "UPDATE user SET pwd = '".$password."', thename='".$thename."', thepic='".$thepic."', thephone='".$thephone."', theQQ='".$theQQ."',theEmail='".$theEmail."',theID='".$theID."', themonth='".$themonth."',theday='".$theday."',thehobby='".$thehobby."' WHERE username='$username'";

		// 	$result2= $db->query($sql2);

		// 	if(!$result2){
		// 		echo 'ц&#65533;9
		// 		exit;
		// 	}
		// 	if($username!=""){
		// 		echo "<script language='javascript'>
  //     	 			alert('ц&#65533;нхЦЬц&#65533;ббббьмф┐оц&#65533;╣цИРхКЯ!'');
		// 		</script>";
		// 	}
		// }
	}
	?>
<body id="bg"  >
	<div id = "container">
    	<div class ="top"><img src="../pic/TOP.gif" /></div>
        <div class = "main">
        	<div class = "left">
       		  <div class="logo" ><img id="bg" src="../pic/logo.gif" /></div>
           	  <div id="item" align="center" ><a href="info.php">цЬАц&#65533;буцГЕц&#65533;е</a></div>
              <div id="item" align="center" ><a href="enroll.php">чбббимббим╛х&#65533;вц&#65533;ехРН</a></div>
              <div id="item" align="center"><a href="benzi.php">ц&#65533;мхн&#65533;ф┐бц&#65533;п</a></div>
              <div id="item" align="center"><a href="../pages/review.html">хОЖхб└&#65533;хЫЮбббзмжб╛</a></div>
              <div id="item" align="center"><a href="aboutus.php">х&#65533;│ф║&#65533;цИСф╗м</a></div>
            </div>
            <div class = "content">
            	<div id="header"><img src="../pic/header2.gif" />
                </div>
               <br>
            	<br>
            	<br>
            	<br>
            	<br>
            	<br>
            	<table align="center">
            		<tr>
            			<td><img src="<?php echo $thepic;?>" width="150px" height="150px"></td>
            		</tr>
                    <tr>
                        <td>чбббимббим╛х&#65533;вхРНчбббиммбуя╝&#65533;</td>
                        <td><p><?php echo $groupname ?></p></td>
                    </tr>
                    <tr>
                        <td>бббзмбббзм┤&#65533;бббзмбббзм┤гф║║я╝&#65533;</td>
                        <td><p><?php echo $thename ?></p></td>
                    </tr>
            	</table>
				<div id="forCenter">
                <a  href="./editprofile.php"><input type="submit" name="btnSubmit" value="ф┐оц&#65533;╣ф┐бц&#65533;п" id="btnSubmit" /></a>
                аа
                <select name = "myselect" onchange="location.href=this.options[this.selectedIndex].value;">
                	<option value="" selected="selected">хПВх&#65533;ац┤╗х&#65533;ббббьм</option>
                    <option value="editbenzi.php">ф╕&#65533;ф╝ац&#65533;мхн&#65533;</option>
                    <option value="editwa.php">ф╕&#65533;ф╝ах&#65533;ббббьмбббзмбббзм╛╣</option>
                </select>
                </a>
                аа
                <a href="enroll.php"><input type="submit" name="btnSubmit" value="ц│ббббьмбббзмжФАч&#65533;╗бббзмжЩЖ" id="btnSubmit" /></a>
                
          		</div>
          </div>		
        </div>
        <div class="linker" align="center">
        	<div class="sublinker"></div>
            <div class="sublinker"></div>
            <div class="sublinker"></div>
            <div class="sublinker"></div>
            <div class="sublinker"></div>
            <div class="sublinker"></div>
            <div class="sublinker"></div>
            <div class="sublinker"></div>
            <div class="sublinker"></div>
            <div class="sublinker"></div>
            
        </div>
        <div class = "footer" align="center"><p>Copyright й 2012. All Rights Reserved</p></div>
	</div>
</body>

    

</html>